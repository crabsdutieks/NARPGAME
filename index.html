<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NARR DIVE</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Lilita+One:wght@700&family=Baloo+2:wght@800&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#0b1d55; --bg2:#0d2f8a;
  --mint:#42ffd4; --pink:#ff84c9; --mango:#ffd166; --violet:#9c8bff;
  --coral:#ff6ea8; --coral-dark:#cc4d83; --coin:#ffd166;
  --mine:#183246; --mineEdge:#bed1df; --hud:#e9fbff; --ink:#052038;
}
*{box-sizing:border-box}
html,body{
  height:100%;margin:0;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:var(--hud);
  font-family:"Baloo 2","Lilita One","Bangers",system-ui,Arial,sans-serif;overflow:hidden
}
#wrap{display:flex;justify-content:center;align-items:center;height:100%}
canvas{display:block;border-radius:18px;box-shadow:0 18px 50px rgba(0,0,0,.5);background:transparent;z-index:1}

/* HUD */
.hud{position:fixed;top:10px;left:10px;right:84px;display:flex;gap:10px;justify-content:flex-start;
  font-weight:800;text-shadow:0 2px 4px #000;pointer-events:none;z-index:15}
.badge{background:rgba(0,0,0,.28);padding:6px 12px;border-radius:14px}

/* Mute */
#muteBtn{position:fixed;top:10px;right:10px;z-index:16;pointer-events:auto;cursor:pointer;
  background:rgba(0,0,0,.35);border:0;border-radius:14px;padding:8px 12px;color:#fff;
  font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.35)}
#muteBtn:active{transform:translateY(1px)}

/* Overlay visible par défaut */
.overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);z-index:20}
.hide{display:none!important}
.card{
  background:linear-gradient(180deg,rgba(15,40,90,.96),rgba(8,24,58,.98));
  border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:24px;min-width:300px;max-width:92vw;
  box-shadow:0 24px 60px rgba(0,0,0,.6);text-align:center;color:#fff
}
.card h1{
  margin:0 0 10px;font-family:"Bangers","Lilita One",sans-serif;font-size:64px;line-height:1;color:var(--mango);
  text-shadow:0 6px 0 rgba(0,0,0,.6),0 0 26px var(--violet)
}
.card p{opacity:.98;margin:6px 0 14px}
.btn{
  appearance:none;border:0;border-radius:14px;padding:12px 20px;margin:6px 8px;cursor:pointer;font-weight:900;
  color:var(--ink);background:linear-gradient(135deg,var(--pink),var(--mango));
  box-shadow:0 8px 0 #b94a86,0 14px 28px rgba(0,0,0,.35);transition:transform .12s,box-shadow .12s
}
.btn:active{transform:translateY(3px);box-shadow:0 4px 0 #b94a86,0 8px 18px rgba(0,0,0,.35)}
.small{font-size:12px;opacity:.78}

/* Tap hint */
.tapHint{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:10}
.tapDot{width:70px;height:70px;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,.9) 0%, rgba(255,255,255,0) 70%);
  animation:pulse 1.2s infinite}
@keyframes pulse{0%{transform:scale(.8);opacity:.9} 70%{transform:scale(1.3);opacity:.2} 100%{transform:scale(1.4);opacity:0}}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="900" height="600" aria-label="NARR DIVE game canvas"></canvas>

  <div class="hud" aria-live="polite">
    <div id="score" class="badge">Score: 0</div>
    <div id="coins" class="badge">Coins: 0</div>
    <div id="best"  class="badge">Best: 0</div>
  </div>
  <button id="muteBtn" aria-pressed="false" title="Mute (M)">🔊</button>

  <!-- overlay visible par défaut -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1 id="title">NARR DIVE</h1>
      <p id="subtitle">Tap / click / space to dive!</p>
      <div>
        <button class="btn" id="btnStart" type="button">Start</button>
        <button class="btn hide" id="btnResume" type="button">Resume</button>
        <button class="btn hide" id="btnRetry"  type="button">Retry</button>
      </div>
      <p class="small">Controls — Space/Click/Touch = flap • P = pause • R = retry • M = mute</p>
    </div>
  </div>

  <!-- tutoriel visuel (disparaît au premier flap) -->
  <div id="tapHint" class="tapHint"><div class="tapDot"></div></div>
</div>

<script>
/* =================== CONFIG =================== */
var CFG={
  gravity: 900, flapVel: -330, baseSpeed: 240, maxDt: 1/30,
  spawnGap: 1.05, startSafeX: 0.42, graceMs: 700,
  ramp:{ speed: 0.08, gapMin: 150, gapMax: 190, gapTighten: 0.12 }
};

/* =================== Canvas =================== */
var cv=document.getElementById('game'), ctx=cv.getContext('2d');
var VIEW={w:900,h:600};
function fitCanvas(){
  var dpr=Math.min(window.devicePixelRatio||1,2);
  var maxW=Math.min(960, window.innerWidth-16);
  var w=Math.max(320,maxW), h=Math.round(w*(600/900));
  cv.style.width=w+'px'; cv.style.height=h+'px';
  cv.width=Math.round(w*dpr); cv.height=Math.round(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  VIEW={w:w,h:h};
  if(mode!=='play'){ player.x=Math.max(player.r+18, Math.floor(VIEW.w*0.32)); }
}
function debounce(fn,ms){var t;return function(){clearTimeout(t);var a=arguments;t=setTimeout(function(){fn.apply(null,a);},ms);};}
window.addEventListener('resize',debounce(fitCanvas,120));

/* =================== HUD & Overlay =================== */
function $(id){return document.getElementById(id);}
var HUD={score:$('#score'),coins:$('#coins'),best:$('#best')};
var best=+localStorage.getItem('narrBest')||0; HUD.best.textContent='Best: '+best;

var overlay=$('#overlay'), title=$('#title'), subtitle=$('#subtitle'),
    btnStart=$('#btnStart'), btnResume=$('#btnResume'), btnRetry=$('#btnRetry'),
    muteBtn=$('#muteBtn'), tapHint=$('#tapHint');

var mode='start';
function showOverlay(state){
  overlay.style.display='grid';
  btnStart.classList.add('hide'); btnResume.classList.add('hide'); btnRetry.classList.add('hide');
  if(state==='start'){ title.textContent='NARR DIVE'; subtitle.textContent='Tap / click / space to dive!'; btnStart.classList.remove('hide'); }
  if(state==='paused'){ title.textContent='Paused'; subtitle.textContent=''; btnResume.classList.remove('hide'); btnRetry.classList.remove('hide'); }
  if(state==='over'){ title.textContent='Game Over'; subtitle.textContent='Final Score: '+score; btnRetry.classList.remove('hide'); }
}
function hideOverlay(){ overlay.style.display='none'; }

/* =================== Utils =================== */
function rand(a,b){return Math.random()*(b-a)+a;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function circleHit(x1,y1,r1,x2,y2,r2){var dx=x1-x2,dy=y1-y2;return (dx*dx+dy*dy)<=((r1+r2)*(r1+r2));}
function circleRectHit(cx,cy,cr, rx,ry,rw,rh){var nx=Math.max(rx,Math.min(cx,rx+rw)), ny=Math.max(ry,Math.min(cy,ry+rh)); var dx=cx-nx,dy=cy-ny; return (dx*dx+dy*dy)<=cr*cr;}
function cssVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

/* =================== Audio (musique avant Start) =================== */
var AudioSys={
  ctx:null,master:null,music:null,sfx:null,started:false,muted:(localStorage.getItem('narrMuted')==='1'),
  init:function(){
    if(this.started) return;
    try{
      var AC=window.AudioContext||window.webkitAudioContext;
      this.ctx = AC ? new AC() : null;
      if(!this.ctx){ this.started=false; return; }
      this.master=this.ctx.createGain(); this.master.connect(this.ctx.destination);
      this.music=this.ctx.createGain(); this.music.gain.value=0.22; this.music.connect(this.master);
      this.sfx=this.ctx.createGain(); this.sfx.gain.value=0.5; this.sfx.connect(this.master);
      this.started=true; if(this.muted) this.toggle(true); this.song();
    }catch(e){ this.started=false; console.warn('Audio disabled:', e); }
  },
  resume:function(){ try{ if(this.ctx && this.ctx.state==='suspended') return this.ctx.resume(); }catch(e){} return Promise.resolve(); },
  startBackground:function(){ this.init(); this.resume(); },
  toggle:function(force){
    if(typeof force==='boolean') this.muted=force; else this.muted=!this.muted;
    if(this.master) this.master.gain.value=this.muted?0:1;
    muteBtn.textContent=this.muted?'🔇':'🔊';
    muteBtn.setAttribute('aria-pressed', String(this.muted));
    localStorage.setItem('narrMuted', this.muted?'1':'0');
  },
  tone:function(freq,type,dur,vol){
    if(this.muted||!this.started) return;
    var o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type=type; o.frequency.value=freq;
    o.connect(g).connect(this.sfx);
    var t=this.ctx.currentTime; g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(t); o.stop(t+dur+0.02);
  },
  flap:function(){ this.tone(520,'square',.07,.9); },
  coin:function(){ this.tone(920,'triangle',.08,1); this.tone(1240,'triangle',.08,.9); },
  point:function(){ this.tone(360,'triangle',.07,.7); },
  hit:function(){ this.tone(120,'sawtooth',.25,1); },
  button:function(){ this.tone(420,'square',.08,.8); },
  song:function(){
    if(!this.started) return;
    var ctx=this.ctx, bus=this.music;
    function loop(){
      if(!AudioSys.started) return;
      var t=ctx.currentTime+0.05;
      var bass=[110,110,123.47,98];
      for(var i=0;i<bass.length;i++){
        var o=ctx.createOscillator(), g=ctx.createGain();
        o.type='sawtooth'; o.frequency.value=bass[i]; o.connect(g).connect(bus);
        g.gain.setValueAtTime(0.0001,t+i*.6); g.gain.exponentialRampToValueAtTime(.25,t+i*.6+.02);
        g.gain.exponentialRampToValueAtTime(.001,t+i*.6+.46); o.start(t+i*.6); o.stop(t+i*.6+.5);
      }
      var notes=[523.25,659.26,784,659.26,587.33,698.46,880,698.46];
      for(var j=0;j<notes.length;j++){
        var a=ctx.createOscillator(), gg=ctx.createGain();
        a.type='triangle'; a.frequency.value=notes[j]; a.connect(gg).connect(bus);
        gg.gain.setValueAtTime(0.0001,t+j*.15); gg.gain.exponentialRampToValueAtTime(.18,t+j*.15+.02);
        gg.gain.exponentialRampToValueAtTime(.001,t+j*.15+.12); a.start(t+j*.15); a.stop(t+j*.15+.14);
      }
      setTimeout(loop,2400);
    }
    loop();
  }
};
muteBtn.addEventListener('click', function(){ AudioSys.toggle(); });

/* =================== Background =================== */
var BG={
  bubbles:(function(){var a=[];for(var i=0;i<36;i++) a.push({x:rand(0,900),y:rand(0,600),r:rand(2,5),s:rand(14,34)}); return a;})(),
  draw:function(t){
    var g=ctx.createLinearGradient(0,0,0,VIEW.h);
    g.addColorStop(0,'#0a3dba'); g.addColorStop(.55,'#1068e0'); g.addColorStop(1,'#0b3b8a');
    ctx.fillStyle=g; ctx.fillRect(0,0,VIEW.w,VIEW.h);
    ctx.globalAlpha=.10; ctx.fillStyle='#a8f9ff';
    for(var i=0;i<4;i++){
      var x=(t*0.05+i*260)%(VIEW.w+320)-320;
      ctx.beginPath(); ctx.moveTo(x,-100); ctx.lineTo(x+260,-100); ctx.lineTo(x+90,340); ctx.lineTo(x-170,340); ctx.closePath(); ctx.fill();
    }
    ctx.globalAlpha=1;
    ctx.fillStyle='rgba(200,246,255,.75)';
    for(var i2=0;i2<this.bubbles.length;i2++){ var b=this.bubbles[i2]; b.y-=b.s*0.016; if(b.y<-10){b.y=VIEW.h+rand(0,120); b.x=rand(0,VIEW.w);} ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
    ctx.fillStyle='#082966'; ctx.beginPath(); ctx.moveTo(0,VIEW.h-70);
    for(var x2=0;x2<=VIEW.w;x2+=48){ var y2=VIEW.h-70 + Math.sin((t*0.003+x2)*0.03)*8; ctx.lineTo(x2,y2); }
    ctx.lineTo(VIEW.w,VIEW.h); ctx.lineTo(0,VIEW.h); ctx.closePath(); ctx.fill();
  }
};

/* =================== Player =================== */
var player={
  x:Math.floor(VIEW.w*0.32), y:Math.floor(VIEW.h*0.55), vy:0, r:26, tilt:0, bubbles:[],
  flap:function(){ this.vy=CFG.flapVel; for(var i=0;i<7;i++) this.bubbles.push({x:this.x-12+rand(-6,6),y:this.y+rand(-6,6),r:rand(2,4),vy:rand(-34,-16),life:rand(.5,.9)}); AudioSys.flap(); tappedOnce=true; tapHint.classList.add('hide'); },
  update:function(dt){ this.vy+=CFG.gravity*dt; this.vy=clamp(this.vy,-420,420); this.y+=this.vy*dt;
    var target=clamp(this.vy/360,-0.6,1.1); this.tilt+=(target-this.tilt)*0.18;
    for(var i=0;i<this.bubbles.length;i++){ var b=this.bubbles[i]; b.y+=b.vy*dt; b.life-=dt; }
    this.bubbles=this.bubbles.filter(function(b){return b.life>0;});
    if(this.y<8||this.y>VIEW.h-8) gameOver();
  },
  draw:function(ctx){
    ctx.fillStyle='rgba(190,240,255,.85)'; for(var i=0;i<this.bubbles.length;i++){ var b=this.bubbles[i]; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.tilt);
    var bw=86,bh=42;
    ctx.fillStyle='#7ff7e6'; ctx.beginPath(); ctx.moveTo(-bw*0.60,6); ctx.lineTo(-bw*0.86,-10); ctx.lineTo(-bw*0.54,-3); ctx.closePath(); ctx.fill();
    var grd=ctx.createLinearGradient(0,-bh,0,bh); grd.addColorStop(0,'#bffff6'); grd.addColorStop(.6,'#6eeedc'); grd.addColorStop(1,'#30b9a9');
    ctx.fillStyle=grd; ctx.strokeStyle='#147a70'; ctx.lineWidth=3; ctx.beginPath(); ctx.ellipse(0,0,bw*0.55,bh*0.55,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#efffff'; ctx.beginPath(); ctx.ellipse(8,12,bw*0.36,bh*0.30,0,0,Math.PI); ctx.fill();
    ctx.fillStyle='#59c8ba'; ctx.beginPath(); ctx.ellipse(12,12,12,7,0.6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#062c35'; ctx.beginPath(); ctx.arc(22,-6,4.2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ffd166'; ctx.lineWidth=5; ctx.beginPath(); ctx.moveTo(30,-8); ctx.lineTo(64,-16); ctx.stroke();
    ctx.strokeStyle='#fff1b8'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(40,-11); ctx.lineTo(48,-13); ctx.stroke();
    ctx.restore();
  }
};

/* =================== Obstacles & Coins =================== */
var obstacles=[], coins=[];
var spawnT=0, score=0, coinCount=0;
var speedMul=1, graceUntil=0, runStartMs=Date.now(), tappedOnce=false;

function currentSpeed(){ return CFG.baseSpeed * speedMul; }
function currentGap(){
  var baseMin=CFG.ramp.gapMin, baseMax=CFG.ramp.gapMax;
  var t=Math.max(0, Math.min(1, (Date.now()-runStartMs)/60000));
  var tighten=1 - CFG.ramp.gapTighten*t;
  return {min: baseMin*tighten, max: baseMax*tighten};
}
function spawnCoralPair(){
  var g=currentGap(); var gap=rand(g.min,g.max);
  var top=rand(50, VIEW.h-220-gap);
  var w=92, x=VIEW.w+40;
  var startSafeRight = VIEW.w*CFG.startSafeX;
  var safeX = (score<3 && x < startSafeRight) ? startSafeRight+60 : x;
  obstacles.push({kind:'pair', x:safeX, w:w, top:top, gap:gap, passed:false});
  if(Math.random()<0.7) coins.push({x:safeX+w*0.6, y:top+gap/2, r:13, got:false});
}
function spawnMine(){
  var r=18, y=rand(220,VIEW.h-80), x=VIEW.w+40;
  var startSafeRight = VIEW.w*CFG.startSafeX;
  var safeX = (score<3 && x < startSafeRight) ? startSafeRight+60 : x;
  obstacles.push({kind:'mine', x:safeX, y:y, r:r, passed:false, phase:Math.random()*Math.PI*2});
}
function drawObstacles(ts){
  for(var i=0;i<obstacles.length;i++){
    var o=obstacles[i];
    if(o.kind==='pair'){
      ctx.fillStyle=cssVar('--coral'); ctx.strokeStyle=cssVar('--coral-dark'); ctx.lineWidth=4;
      ctx.fillRect(o.x,0,o.w,o.top); ctx.strokeRect(o.x,0,o.w,o.top);
      for(var k=0;k<o.w;k+=18){ ctx.beginPath(); ctx.moveTo(o.x+k,o.top); ctx.lineTo(o.x+k+9,o.top-13); ctx.lineTo(o.x+k+18,o.top); ctx.fillStyle='#ff95cd'; ctx.fill(); }
      var by=o.top+o.gap, bh=VIEW.h-by;
      ctx.fillRect(o.x,by,o.w,bh); ctx.strokeRect(o.x,by,o.w,bh);
      for(var k2=0;k2<o.w;k2+=18){ ctx.beginPath(); ctx.moveTo(o.x+k2,by); ctx.lineTo(o.x+k2+9,by+13); ctx.lineTo(o.x+k2+18,by); ctx.fillStyle='#ff95cd'; ctx.fill(); }
    }else{
      var r=o.r;
      ctx.strokeStyle='#6b8aa3'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(o.x,o.y-42); ctx.lineTo(o.x,o.y-10); ctx.stroke();
      ctx.strokeStyle=cssVar('--mineEdge'); ctx.lineWidth=3;
      for(var s=0;s<8;s++){ var a=s*(Math.PI/4); ctx.beginPath(); ctx.moveTo(o.x+Math.cos(a)*r,o.y+Math.sin(a)*r); ctx.lineTo(o.x+Math.cos(a)*(r+12),o.y+Math.sin(a)*(r+12)); ctx.stroke(); }
      ctx.fillStyle=cssVar('--mine'); ctx.beginPath(); ctx.arc(o.x,o.y,r,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle=cssVar('--mineEdge'); ctx.lineWidth=2; ctx.stroke();
    }
  }
}
function drawCoins(){
  for(var i=0;i<coins.length;i++){
    var c=coins[i]; if(c.got) continue;
    var g=ctx.createRadialGradient(c.x,c.y,2,c.x,c.y,c.r+9);
    g.addColorStop(0,'rgba(255,209,102,.96)'); g.addColorStop(1,'rgba(255,209,102,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(c.x,c.y,c.r+9,0,Math.PI*2); ctx.fill();
    ctx.save(); ctx.translate(c.x,c.y); ctx.rotate((Date.now()%2000)/2000*2*Math.PI);
    ctx.fillStyle=cssVar('--coin'); ctx.strokeStyle='#d5a63a'; ctx.lineWidth=2;
    ctx.beginPath(); var spikes=5,outer=c.r,inner=c.r*0.45;
    for(var j=0;j<spikes*2;j++){ var ang=j*Math.PI/spikes; var rr=(j%2===0)?outer:inner; ctx.lineTo(Math.cos(ang)*rr,Math.sin(ang)*rr); }
    ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
  }
}

/* =================== Game State & Loop =================== */
var lastTS=0;
function resetGame(){
  score=0; coinCount=0; obstacles.length=0; coins.length=0;
  player.x=Math.max(player.r+18, Math.floor(VIEW.w*0.32)); player.y=Math.floor(VIEW.h*0.55); player.vy=0; player.tilt=0; player.bubbles=[];
  HUD.score.textContent='Score: 0'; HUD.coins.textContent='Coins: 0';
  spawnT=0; speedMul=1; runStartMs=Date.now(); graceUntil=Date.now()+CFG.graceMs; tappedOnce=false;
  tapHint.classList.remove('hide');
}
function startGame(){ resetGame(); mode='play'; hideOverlay(); lastTS=performance.now(); requestAnimationFrame(loop); }
function pauseGame(){ if(mode!=='play') return; mode='paused'; showOverlay('paused'); }
function resumeGame(){ if(mode!=='paused') return; mode='play'; hideOverlay(); graceUntil=Date.now()+CFG.graceMs; }
function gameOver(){
  if(mode!=='play') return;
  mode='over';
  if(score>best){ best=score; localStorage.setItem('narrBest',best); }
  HUD.best.textContent='Best: '+best;
  showOverlay('over'); AudioSys.hit(); flashWhite(160);
}

/* =================== Update & Draw =================== */
function update(dt,ts){
  var tmax=60, prog=Math.max(0, Math.min(1, (Date.now()-runStartMs)/1000/tmax));
  speedMul = 1 + CFG.ramp.speed*prog;

  // spawn
  spawnT+=dt;
  var gap = CFG.spawnGap * (1 - 0.15*prog);
  if(spawnT>=gap){ spawnT=0; spawnCoralPair(); if(Math.random()<0.45+0.15*prog) spawnMine(); }

  var spd=currentSpeed();

  // move
  for(var i=0;i<obstacles.length;i++){ var o=obstacles[i]; o.x-=spd*dt; if(o.kind==='mine'){ o.y+=Math.sin(ts/1000 + o.phase)*0.6; } }
  for(var j=0;j<coins.length;j++){ coins[j].x-=spd*dt; }

  // cleanup
  while(obstacles.length && (obstacles[0].x + (obstacles[0].w||obstacles[0].r*2)) < -120) obstacles.shift();
  while(coins.length && coins[0].x < -120) coins.shift();

  // scoring
  for(var k=0;k<obstacles.length;k++){
    var op=obstacles[k];
    if(op.kind==='pair' && !op.passed && (op.x+op.w) < player.x){
      op.passed=true; score+=1; HUD.score.textContent='Score: '+score; AudioSys.point();
    }
  }

  // coins
  for(var c=0;c<coins.length;c++){
    var cc=coins[c];
    if(!cc.got && circleHit(player.x,player.y,player.r*1.05, cc.x,cc.y,cc.r*1.25)){
      cc.got=true; coinCount++; score+=5; HUD.coins.textContent='Coins: '+coinCount; HUD.score.textContent='Score: '+score; AudioSys.coin();
    }
  }

  // collisions + grace
  if(Date.now()>graceUntil){
    var pr = player.r*0.98;
    for(var m=0;m<obstacles.length;m++){
      var ob=obstacles[m];
      if(ob.kind==='pair'){
        if(circleRectHit(player.x,player.y,pr, ob.x,0,ob.w,ob.top)) return gameOver();
        var by=ob.top+ob.gap, bh=VIEW.h-by;
        if(circleRectHit(player.x,player.y,pr, ob.x,by,ob.w,bh)) return gameOver();
      } else {
        if(circleHit(player.x,player.y,pr, ob.x,ob.y,ob.r)) return gameOver();
      }
    }
  }

  player.update(dt);
}
function draw(ts){
  ctx.clearRect(0,0,VIEW.w,VIEW.h);
  BG.draw(ts); drawObstacles(ts); drawCoins(); player.draw(ctx);
}
function loop(ts){
  if(mode!=='play'){ lastTS=ts; requestAnimationFrame(loop); return; }
  var dt=(ts-lastTS)/1000; lastTS=ts;
  if(dt>0.25) dt=CFG.maxDt;
  dt=Math.min(CFG.maxDt, Math.max(0, dt));
  update(dt,ts); draw(ts);
  requestAnimationFrame(loop);
}

/* =================== FX =================== */
function flashWhite(ms){
  var start=performance.now(); ms=ms||160;
  (function f(t){ var a=1-(t-start)/ms; if(a>0){ ctx.save(); ctx.globalAlpha=a*.6; ctx.fillStyle='#fff'; ctx.fillRect(0,0,VIEW.w,VIEW.h); ctx.restore(); requestAnimationFrame(f);} })(start);
}

/* =================== Inputs =================== */
function onFlap(){ if(mode==='play'){ player.flap(); AudioSys.resume(); } }

// START : lance direct (audio ne peut pas bloquer)
btnStart.onclick = function(){
  try{ AudioSys.button(); }catch(e){}
  startGame();
};
btnResume.onclick = function(){ AudioSys.button(); resumeGame(); };
btnRetry.onclick  = function(){ AudioSys.button(); startGame(); };

// Canvas pointer
cv.addEventListener('pointerdown', function(){ if(mode==='play') onFlap(); });

// Clavier
window.addEventListener('keydown', function(e){
  if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); onFlap(); }
  if(e.code==='KeyP'){ if(mode==='play') pauseGame(); else if(mode==='paused') resumeGame(); }
  if(e.code==='KeyR'){ if(mode==='over') startGame(); }
  if(e.code==='KeyM'){ AudioSys.toggle(); }
});

// Auto-pause onglet
document.addEventListener('visibilitychange', function(){
  if(document.hidden && mode==='play') pauseGame();
});

/* =================== Boot =================== */
var score=0, coinCount=0, spawnT=0, graceUntil=0, runStartMs=Date.now(), speedMul=1, tappedOnce=false;
window.addEventListener('DOMContentLoaded', function(){
  fitCanvas();
  showOverlay('start');
  // Musique AVANT Start (si bloquée, on déverrouille au prochain geste global)
  AudioSys.startBackground();
  function unlock(){ AudioSys.resume(); window.removeEventListener('pointerdown',unlock,true); window.removeEventListener('pointermove',unlock,true); window.removeEventListener('keydown',unlock,true); }
  window.addEventListener('pointerdown',unlock,true);
  window.addEventListener('pointermove',unlock,true);
  window.addEventListener('keydown',unlock,true);
  if(AudioSys.muted) AudioSys.toggle(true);
});
</script>
</body>
</html>
```0
