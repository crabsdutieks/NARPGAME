<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>$NARPE Mini-Game ‚Äî Swim & Dodge</title>
<meta name="theme-color" content="#6a00ff" />
<style>
  :root{ --violet:#6a00ff; --night:#001f4d; --teal:#16c7be; --gold:#ffd75e; --glass:rgba(255,255,255,.08)}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--violet),var(--night));
    color:#fff; font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
    overflow:hidden;
  }
  #canvas{display:block; width:100vw; height:100vh}
  /* HUD */
  #hud{position:fixed; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; padding:env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .pill{
    background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.16);
    padding:8px 12px; border-radius:12px; backdrop-filter:blur(6px); font-weight:800; letter-spacing:.3px
  }
  .btn{
    pointer-events:auto; user-select:none; cursor:pointer;
    background:var(--teal); color:#081018; border:none; font-weight:900;
    padding:10px 14px; border-radius:12px; box-shadow:0 6px 0 rgba(0,0,0,.35);
    transition:transform .06s ease, filter .2s ease;
  }
  .btn:active{transform:translateY(2px); box-shadow:0 4px 0 rgba(0,0,0,.35)}
  /* Overlays */
  #overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.38); backdrop-filter:blur(6px); z-index:5}
  #overlay.show{display:grid}
  .card{
    width:min(560px,92vw);
    background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.05));
    border:1px solid rgba(255,255,255,.16); border-radius:18px; padding:20px; text-align:center
  }
  h1{margin:.2rem 0 0; font-size:1.6rem}
  p{margin:.35rem 0; opacity:.92}
  .hint{font-size:.9rem; opacity:.85}
  .actions{display:flex; gap:10px; justify-content:center; margin-top:12px}
  .btn.alt{background:#fff;color:#111}
  .btn.gold{background:var(--gold); color:#111}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<!-- HUD -->
<div id="hud">
  <div class="row" style="padding:10px">
    <div class="pill" id="score">Score: 0</div>
    <div class="row" style="gap:8px">
      <div class="pill" id="best">Best: 0</div>
      <button id="pauseBtn" class="btn" aria-label="Pause">Pause</button>
    </div>
  </div>
  <div class="row" style="padding:10px">
    <a class="btn gold" href="/" title="Back to site">‚Üê Back</a>
    <button id="restartBtn" class="btn">Restart</button>
  </div>
</div>

<!-- Start / Game Over overlay -->
<div id="overlay" class="show" role="dialog" aria-modal="true">
  <div class="card">
    <h1 id="title">$NARPE ‚Äî Swim & Dodge</h1>
    <p id="subtitle">Tap / Space / ‚Üë to swim. Avoid ice & mines, collect coins for bonus points.</p>
    <p class="hint">Mobile: tap anywhere ¬∑ Desktop: Space or ‚Üë</p>
    <div class="actions">
      <button id="playBtn" class="btn">Play</button>
      <button id="howBtn" class="btn alt">How to</button>
    </div>
    <div class="actions" id="shareWrap" style="display:none">
      <button id="shareBtn" class="btn gold">Share score on X</button>
    </div>
  </div>
</div>

<script>
(()=>{
// ===== Canvas / DPI =====
const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function resize(){
  canvas.width = Math.floor(innerWidth*dpr);
  canvas.height = Math.floor(innerHeight*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', resize, {passive:true}); resize();

// ===== Assets (optional Narpe PNG) =====
const narpeImg = new Image(); let narpeReady = false;
narpeImg.onload = ()=> narpeReady = true;
narpeImg.onerror = ()=> narpeReady = false;
narpeImg.src = 'narpe.png'; // optional

// ===== State =====
let running=false, paused=false, over=false;
let tLast=0, time=0;
let score=0, coins=0, streak=0;
let best = Number(localStorage.getItem('narpe_best')||0);
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
bestEl.textContent = 'Best: '+best;
const overlay = document.getElementById('overlay');
const title = document.getElementById('title');
const subtitle = document.getElementById('subtitle');
const playBtn = document.getElementById('playBtn');
const howBtn = document.getElementById('howBtn');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const shareWrap = document.getElementById('shareWrap');
const shareBtn = document.getElementById('shareBtn');

// Physics / difficulty (easier start)
const G = 1100;          // gravity
const SWIM = -480;       // swim impulse
const MAX_VY = 700;

const narpe = { x: innerWidth*0.24, y: innerHeight*0.5, vy:0, r:38, tilt:0 };
const obs = [];  // obstacles
const pcs = [];  // coins
let spawnTimer=0;

// Helpers
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rnd=(a,b)=>a+Math.random()*(b-a);
function circleHit(ax,ay,ar,bx,by,br){const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy<(ar+br)*(ar+br);}

// Input
function swim(){
  if(!running){ start(); return; }
  if(over||paused) return;
  narpe.vy = SWIM;
}
addEventListener('keydown',e=>{
  if([' ','ArrowUp','Spacebar'].includes(e.key)){ e.preventDefault(); swim(); }
  if(e.key==='p'){ togglePause(); }
});
addEventListener('pointerdown', ()=>swim(), {passive:true});

// UI
playBtn.onclick = ()=> start();
howBtn.onclick = ()=> subtitle.textContent = 'Swim up with tap/Space. Pass gates for +1, collect coins for +5 and streak bonus. Avoid obstacles.';
pauseBtn.onclick = ()=> togglePause();
restartBtn.onclick = ()=> reset(true);
shareBtn.onclick = ()=>{
  const text = encodeURIComponent(`I just scored ${score} in the $NARPE Swim & Dodge mini-game! üåäü¶Ñ #NARPE #Abstract`);
  const url = encodeURIComponent(location.origin);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,'_blank');
};

function showOverlay(show){ overlay.classList.toggle('show', !!show); }
function togglePause(){
  if(!running||over) return;
  paused=!paused;
  pauseBtn.textContent = paused? 'Resume' : 'Pause';
  if(paused){ showOverlay(true); title.textContent='Paused'; subtitle.textContent='Tap / Space / ‚Üë to continue.'; shareWrap.style.display='none';}
  else{ showOverlay(false); }
}

// Game flow
function start(){
  reset(false);
  running=true; paused=false; over=false;
  tLast=performance.now(); showOverlay(false);
  requestAnimationFrame(loop);
}
function reset(hard){
  score=0; coins=0; streak=0;
  scoreEl.textContent='Score: 0';
  narpe.x=innerWidth*0.24; narpe.y=innerHeight*0.5; narpe.vy=0; narpe.tilt=0;
  obs.length=0; pcs.length=0; spawnTimer=0;
  if(hard){ running=false; over=false; paused=false; showOverlay(true); title.textContent='$NARPE ‚Äî Swim & Dodge'; subtitle.textContent='Tap / Space / ‚Üë to swim. Avoid ice & mines, collect coins.'; shareWrap.style.display='none';}
}
function end(){
  over=true; running=false; paused=false;
  if(score>best){ best=score; localStorage.setItem('narpe_best',best); bestEl.textContent='Best: '+best; }
  title.textContent='Game Over';
  subtitle.textContent=`Score: ${score} ‚Ä¢ Best: ${best} ‚Ä¢ Coins: ${coins}`;
  shareWrap.style.display='flex';
  showOverlay(true);
}

// Spawning (gentle start, ramps up)
function spawn(){
  const baseSpeed = 160;               // slower start
  const maxExtra = 240;                // cap increase
  const speed = baseSpeed + Math.min(maxExtra, score*1.1);
  const gapStart = 220;                // wider gap initially
  const gap = clamp(gapStart - score*0.35, 140, 220);
  const yMid = rnd(innerHeight*0.30, innerHeight*0.70);

  // random type mix
  const types = ['ice','mine'];
  const typeTop = Math.random()<0.7? 'ice':'mine';
  const typeBot = Math.random()<0.6? 'ice':'mine';

  obs.push({x: innerWidth+40, y: yMid-gap/2-160, w:60, h:260, vx:-speed, type:typeTop, passed:false});
  obs.push({x: innerWidth+40, y: yMid+gap/2,   w:60, h:260, vx:-speed, type:typeBot, passed:false});

  // coins: 60% chance
  if(Math.random()<0.6){
    pcs.push({x: innerWidth+ 40 + rnd(120,180), y: yMid + rnd(-gap/2.5, gap/2.5), r:12, vx:-speed, got:false});
  }

  // next spawn timer (slightly faster with score)
  spawnTimer = 1.55 - Math.min(0.8, score*0.002);
}

// Draw helpers
function bg(dt, tm){
  const w=innerWidth,h=innerHeight;
  ctx.clearRect(0,0,w,h);
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0,'#0a2a6b'); g.addColorStop(1,'#041632');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  // rays
  for(let i=0;i<5;i++){
    const x = (tm*0.02 + i*220)%(w+220)-220;
    ctx.globalAlpha=.07; ctx.fillStyle='#7fd1ff';
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x+140,0); ctx.lineTo(x+40,h); ctx.lineTo(x-100,h); ctx.closePath(); ctx.fill();
    ctx.globalAlpha=1;
  }
  // soft bubbles
  for(let i=0;i<18;i++){
    const bx=(tm*0.12 + i*(w/18))%(w+80)-40;
    const by=(tm*0.06 + i*40)%(h+40)-20;
    ctx.globalAlpha=.38; ctx.fillStyle='#b8f0ff';
    ctx.beginPath(); ctx.arc(bx,h-by,3+(i%3),0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
  }
}

function drawNarpe(x,y,tilt){
  if(narpeReady){
    const s=96; ctx.save(); ctx.translate(x,y); ctx.rotate(tilt*0.04);
    ctx.drawImage(narpeImg,-s*0.6,-s*0.6,s*1.2,s*1.2); ctx.restore();
  }else{
    // fallback cartoon narwhal (cute)
    ctx.save(); ctx.translate(x,y); ctx.rotate(tilt*0.04);
    ctx.fillStyle='#bfe7ff'; ctx.beginPath(); ctx.ellipse(0,0,44,34,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#e8f7ff'; ctx.beginPath(); ctx.ellipse(0,8,26,20,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#bfe7ff'; ctx.beginPath(); ctx.moveTo(-40,8); ctx.quadraticCurveTo(-64,0,-44,-8); ctx.quadraticCurveTo(-28,0,-40,8); ctx.fill();
    ctx.strokeStyle='#503200'; ctx.lineWidth=2; ctx.fillStyle='#ffd75e';
    ctx.beginPath(); ctx.moveTo(22,-18); ctx.lineTo(58,-28); ctx.lineTo(20,-8); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(8,-4,12,10,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(12,-4,4,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ed6a5a'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(6,10,12,.2*Math.PI,.9*Math.PI); ctx.stroke();
    ctx.restore();
  }
}
function drawObstacle(o){
  ctx.save(); ctx.translate(o.x,o.y);
  if(o.type==='ice'){
    ctx.fillStyle='#9fe3ff'; ctx.strokeStyle='#4aa7c7'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(o.w,10); ctx.lineTo(o.w,o.h); ctx.lineTo(0,o.h); ctx.closePath(); ctx.fill(); ctx.stroke();
  }else{
    ctx.fillStyle='#5c6b7a'; ctx.beginPath(); ctx.arc(o.w*0.5,o.h*0.5,24,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#7f8fa0';
    for(let k=0;k<6;k++){ const a=k*Math.PI/3,R=34; ctx.beginPath(); ctx.arc(o.w*0.5+Math.cos(a)*R,o.h*0.5+Math.sin(a)*R,4,0,Math.PI*2); ctx.fill(); }
  }
  ctx.restore();
}
function drawCoin(p){
  ctx.save(); ctx.translate(p.x,p.y);
  const r=p.r, g=ctx.createRadialGradient(0,0,2,0,0,r);
  g.addColorStop(0,'#fff5cc'); g.addColorStop(1,'#ffd75e');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=2; ctx.stroke();
  ctx.restore();
}

// Loop
function loop(now){
  if(!running) return;
  const dt=Math.min(0.04,(now-tLast)/1000); tLast=now; time+=dt;
  if(!paused && !over){
    // physics
    narpe.vy += G*dt; narpe.vy = clamp(narpe.vy, SWIM*1.3, MAX_VY);
    narpe.y += narpe.vy * dt; narpe.y = clamp(narpe.y, 30, innerHeight-30);
    narpe.tilt = narpe.vy / 200;

    // spawn
    spawnTimer -= dt; if(spawnTimer<=0) spawn();

    // move
    for(const o of obs) o.x += o.vx*dt;
    for(const p of pcs) p.x += p.vx*dt;

    // collisions / scoring
    for(const o of obs){
      // rect collision (circle to rectangle)
      const cx = clamp(narpe.x, o.x, o.x+o.w);
      const cy = clamp(narpe.y, o.y, o.y+o.h);
      const dx = narpe.x - cx, dy = narpe.y - cy;
      if(dx*dx+dy*dy < (narpe.r*0.75)*(narpe.r*0.75)){ end(); return; }
      if(!o.passed && o.x+o.w < narpe.x){ o.passed = true; score += 1; scoreEl.textContent='Score: '+score; }
    }
    for(const p of pcs){
      if(!p.got && circleHit(narpe.x,narpe.y,narpe.r*0.7, p.x,p.y,p.r)){
        p.got = true; coins++; streak = Math.min(streak+1, 10);
        const bonus = 5 + Math.floor(streak/3); // small streak bonus
        score += bonus; scoreEl.textContent='Score: '+score;
      }
    }
    // cleanup
    while(obs.length && obs[0].x + obs[0].w < -80) obs.shift();
    while(pcs.length && pcs[0].x < -80) pcs.shift();
  }

  // draw
  bg(dt, time*60);
  for(const o of obs) drawObstacle(o);
  for(const p of pcs) if(!p.got) drawCoin(p);
  drawNarpe(narpe.x, narpe.y, narpe.tilt);

  requestAnimationFrame(loop);
}

// Start screen visible initially (overlay has .show)
function showStart(){
  title.textContent = '$NARPE ‚Äî Swim & Dodge';
  subtitle.textContent = 'Tap / Space / ‚Üë to swim. Avoid ice & mines, collect coins for bonus points.';
  shareWrap.style.display='none';
  showOverlay(true);
}
function endEarlyIfStuckMenu(){ /* safety: ensure overlay closes on play */ showOverlay(false); }

showStart();
})();
</script>
</body>
</html>
