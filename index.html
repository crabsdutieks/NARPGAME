<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>CUTE HERO vs MONSTERS ‚Äî OMNI-DEV ‚àû SINGULARITY</title>
<style>
  :root{
    --bg:#ffeef6; --ink:#2b2b2b; --accent:#ff69b4; --mint:#7ef5c9; --sky:#b0e2ff; --sun:#ffd166; --violet:#c9a0ff;
    --danger:#ff4d6d; --good:#2ecc71; --gold:#ffcc33;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg); color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
  #root{position:fixed; inset:0; display:grid; grid-template-rows: 1fr; place-items:stretch;}
  canvas{display:block; width:100%; height:100%; touch-action:none; background: radial-gradient(1200px 900px at 50% 60%, #ffffff 0%, #fff7fb 50%, #ffeef6 100%);}
  /* UI Layers */
.overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
  .panel{pointer-events:auto; background:#fff; border:2px solid #00000020; border-radius:20px; padding:20px; box-shadow:0 10px 30px #00000014; max-width: min(560px, 92vw)}
  h1{margin:.3rem 0 1rem; font-weight:900; letter-spacing:.5px}
  .btn{appearance:none; border:0; background:var(--accent); color:#fff; padding:14px 18px; border-radius:14px; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 6px 0 #cf3b7b; transform:translateY(0); transition:.1s}
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(2px); box-shadow:0 4px 0 #cf3b7b}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .muted{opacity:.7; font-size:14px}
  .pill{display:inline-flex; align-items:center; gap:6px; font-weight:700; padding:6px 10px; border-radius:999px; background:#00000008; border:1px dashed #0000001a}
  .hud{position:fixed; left:10px; top:10px; right:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:14px; background:#ffffffaa; backdrop-filter: blur(6px); border:1px solid #00000010}
  .hearts{display:flex; gap:6px}
  .heart{width:18px; height:16px; background:var(--danger); clip-path:path("M9 16C9 16 0 10 0 5.5C0 3.5 1.5 2 3.5 2C5.1 2 6.5 3 7 4C7.5 3 8.9 2 10.5 2C12.5 2 14 3.5 14 5.5C14 10 9 16 9 16Z")}
  .stat{font-weight:900}
  .bossbar{position:fixed; left:50%; transform:translateX(-50%); bottom:14px; width:min(520px,86vw); height:16px; border-radius:10px; background:#00000012; border:1px solid #00000020; overflow:hidden}
  .bossbar > i{display:block; height:100%; background:linear-gradient(90deg, #ff4d6d, #ffd166); width:0%}
  /* Mobile Controls */
  .controls{position:fixed; inset:0; pointer-events:none}
  .stick{position:fixed; left:16px; bottom:22px; width:140px; height:140px; border-radius:50%; background:#0000000d; border:1px solid #00000015; pointer-events:auto; touch-action:none}
  .stick .knob{position:absolute; left:50%; top:50%; width:70px; height:70px; margin:-35px; border-radius:50%; background:#ffffffcc; border:2px solid #00000020; box-shadow:0 6px 18px #00000025}
  .attack{position:fixed; right:22px; bottom:38px; width:96px; height:96px; border-radius:50%; background:var(--accent); color:#fff; font-weight:900; font-size:14px; display:flex; align-items:center; justify-content:center; border:0; box-shadow:0 8px 0 #cf3b7b; pointer-events:auto}
  .attack:active{transform:translateY(2px); box-shadow:0 6px 0 #cf3b7b}
  .toggle{appearance:none; background:#fff; border:1px solid #00000022; border-radius:12px; padding:8px 12px; font-weight:800}
  /* Confetti canvas covers on victory chest open */
  #fx{position:fixed; inset:0; pointer-events:none}
  @media (min-width:900px){
    .stick{left:22px; bottom:26px}
  }
</style>
</head>
<body>
<div id="root">
  <canvas id="game" aria-label="Cute Hero vs Monsters (Canvas Game)"></canvas>
  <canvas id="fx"></canvas>
</div>

<!-- HUD -->
<div class="hud" id="hud" style="display:none">
  <div class="row" style="align-items:center; gap:14px;">
    <span class="pill">Score: <span class="stat" id="score">0</span></span>
    <span class="pill">High: <span class="stat" id="high">0</span></span>
    <span class="pill">Wave: <span class="stat" id="wave">1</span></span>
    <span class="pill">Monsters: <span class="stat" id="left">0</span></span>
    <span class="pill"><button id="mute" class="toggle" title="Toggle Sound">üîä Sound</button></span>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<div class="bossbar" id="bossbar" style="display:none"><i id="bossfill"></i></div>

<!-- MENU -->
<div class="overlay" id="menu">
  <div class="panel">
    <h1>üíñ Cute Hero vs Monsters</h1>
    <p class="muted">Move, shoot hearts, clear waves. Beat the final boss. Open the chest for a reward.</p>
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="startBtn">Tap to Start</button>
      <button class="btn" id="howBtn" style="background:var(--mint); box-shadow:0 6px 0 #1ea77c">How to Play</button>
    </div>
    <p class="muted" style="margin-top:10px">
      üïπÔ∏è <b>Keyboard</b>: WASD / Arrows to move, <b>Space</b> to shoot.<br/>
      üì± <b>Mobile</b>: Joystick + big pink button to shoot. Sound starts after tapping Start.
    </p>
    <div class="row">
      <span class="pill">One file</span>
      <span class="pill">Responsive Canvas</span>
      <span class="pill">LocalStorage Highscore</span>
      <span class="pill">Boss + Chest Rewards</span>
    </div>
  </div>
</div>

<!-- HOW -->
<div class="overlay" id="how" style="display:none">
  <div class="panel">
    <h1>How to Play</h1>
    <ul style="line-height:1.5; margin:0 0 12px 18px;">
      <li>Clear waves by shooting heart projectiles üíò</li>
      <li>Don‚Äôt let monsters touch you ‚Äî you have 5 hearts ‚ù§Ô∏è</li>
      <li>Defeat the boss to spawn the treasure chest ‚ú®</li>
      <li>Open the chest to unlock a cosmetic reward (saved) üéÅ</li>
    </ul>
    <div class="row">
      <button class="btn" id="backBtn" style="background:var(--sky); box-shadow:0 6px 0 #5aa6d1">Back</button>
      <button class="btn" id="startBtn2">Play Now</button>
    </div>
  </div>
</div>

<!-- GAME OVER / VICTORY -->
<div class="overlay" id="end" style="display:none">
  <div class="panel">
    <h1 id="endTitle">Game Over</h1>
    <p id="endText" class="muted">Your score: <span id="endScore">0</span></p>
    <div class="row">
      <button class="btn" id="againBtn">Play Again</button>
      <button class="btn" id="tweetBtn" style="background:var(--violet); box-shadow:0 6px 0 #8f6ae6">Share</button>
    </div>
  </div>
</div>

<!-- MOBILE CONTROLS -->
<div class="controls" id="controls" style="display:none">
  <div class="stick" id="stick"><div class="knob" id="knob"></div></div>
  <button class="attack" id="attackBtn" aria-label="Shoot">üíò</button>
</div>

<script>
(() => {
  'use strict';

  // ===== Canvas & DPI =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const fx = document.getElementById('fx');
  const fxc = fx.getContext('2d');

  let DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
  function resize() {
    DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    const w = Math.floor(window.innerWidth);
    const h = Math.floor(window.innerHeight);
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    fx.width = canvas.width;
    fx.height = canvas.height;
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ===== Game State =====
  const STATE = { MENU:0, PLAY:1, BOSS:2, VICTORY:3, OVER:4 };
  let state = STATE.MENU;

  const hud = {
    root: document.getElementById('hud'),
    score: document.getElementById('score'),
    high: document.getElementById('high'),
    wave: document.getElementById('wave'),
    left: document.getElementById('left'),
    hearts: document.getElementById('hearts'),
    mute: document.getElementById('mute'),
    bossbar: document.getElementById('bossbar'),
    bossfill: document.getElementById('bossfill')
  };

  const menu = document.getElementById('menu');
  const how = document.getElementById('how');
  const end = document.getElementById('end');
  const endTitle = document.getElementById('endTitle');
  const endText = document.getElementById('endText');
  const endScore = document.getElementById('endScore');

  const btn = {
    start: document.getElementById('startBtn'),
    start2: document.getElementById('startBtn2'),
    how: document.getElementById('howBtn'),
    back: document.getElementById('backBtn'),
    again: document.getElementById('againBtn'),
    tweet: document.getElementById('tweetBtn'),
  };

  const controls = document.getElementById('controls');
  const stick = document.getElementById('stick');
  const knob = document.getElementById('knob');
  const attackBtn = document.getElementById('attackBtn');

  // ===== LocalStorage =====
  const LS = {
    get high(){ return +localStorage.getItem('cute_highscore') || 0; },
    set high(v){ localStorage.setItem('cute_highscore', String(v)); },
    get skin(){ return localStorage.getItem('cute_skin') === '1'; },
    set skin(v){ localStorage.setItem('cute_skin', v ? '1' : '0'); }
  };
  hud.high.textContent = LS.high;

  // ===== Audio (WebAudio Beeps) =====
  let audioEnabled = true;
  let actx = null;
  function ensureAudio() {
    if (!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
    if (actx.state === 'suspended') actx.resume();
  }
  function beep({freq=600, time=0.07, type='sine', vol=0.15, decay=0.02}) {
    if (!audioEnabled) return;
    ensureAudio();
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g).connect(actx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + time - decay);
    o.stop(actx.currentTime + time);
  }
  hud.mute.addEventListener('click', () => {
    audioEnabled = !audioEnabled;
    hud.mute.textContent = audioEnabled ? 'üîä Sound' : 'üîá Muted';
    if (audioEnabled) ensureAudio();
  });

  // ===== Input =====
  const keys = {};
  window.addEventListener('keydown', e => { keys[e.code] = true; if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault(); }, {passive:false});
  window.addEventListener('keyup', e => { keys[e.code] = false; }, {passive:true});

  // Virtual joystick
  let jActive = false, jVec = {x:0,y:0};
  function stickPos(e){
    const rect = stick.getBoundingClientRect();
    const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
    const t = (e.touches && e.touches[0]) || e;
    const dx = t.clientX - cx, dy = t.clientY - cy;
    const max = rect.width * 0.45;
    const len = Math.hypot(dx,dy);
    const nx = len ? dx/len : 0, ny = len ? dy/len : 0;
    const m = Math.min(1, len/max);
    jVec.x = nx * m; jVec.y = ny * m;
    knob.style.transform = `translate(${nx*m*max}px, ${ny*m*max}px)`;
  }
  function stickEnd(){ jActive=false; jVec.x=jVec.y=0; knob.style.transform='translate(0,0)'; }

  stick.addEventListener('pointerdown', (e)=>{ jActive=true; stick.setPointerCapture(e.pointerId); stickPos(e); }, {passive:false});
  stick.addEventListener('pointermove', (e)=>{ if(jActive){ stickPos(e); e.preventDefault(); }}, {passive:false});
  stick.addEventListener('pointerup', ()=>stickEnd(), {passive:true});
  stick.addEventListener('pointercancel', ()=>stickEnd(), {passive:true});

  let attackPressed = false;
  attackBtn.addEventListener('pointerdown', ()=>{ attackPressed = true; }, {passive:true});
  attackBtn.addEventListener('pointerup', ()=>{ attackPressed = false; }, {passive:true});
  window.addEventListener('blur', ()=>{ attackPressed=false; }, {passive:true});

  // ===== Entities =====
  const rand = (a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const W=()=>canvas.width, H=()=>canvas.height;

  function drawCuteCharacter(x,y,r,altSkin=false){
    // Body
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(1,1);
    // shadow
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.beginPath(); ctx.ellipse(0,r*1.05,r*1.2,r*0.35,0,0,Math.PI*2); ctx.fill();

    // head
    ctx.fillStyle = altSkin ? '#ffe0f2' : '#fff';
    ctx.strokeStyle = '#00000020';
    roundRect(-r*1.1,-r*1.1,r*2.2,r*2, r*0.4);
    ctx.fill(); ctx.stroke();

    // ears
    ctx.fillStyle = altSkin ? '#ffc4e6' : '#ffe4ef';
    ctx.beginPath(); ctx.arc(-r*0.8,-r*1.1,r*0.45,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.8,-r*1.1,r*0.45,0,Math.PI*2); ctx.fill();

    // face
    ctx.fillStyle = '#ff6aa0';
    ctx.beginPath(); ctx.arc(-r*0.35,-r*0.1,r*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.35,-r*0.1,r*0.18,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#333';
    ctx.beginPath(); ctx.arc(-r*0.35,-r*0.1,r*0.08,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(r*0.35,-r*0.1,r*0.08,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#ffb7c8';
    ctx.beginPath(); ctx.arc(0,r*0.1,r*0.12,0,Math.PI*2); ctx.fill();

    // bow
    ctx.fillStyle = '#ff69b4';
    ctx.beginPath(); ctx.ellipse(-r*0.55,-r*0.75,r*0.28,r*0.18,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(-r*0.15,-r*0.75,r*0.28,r*0.18,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#ff88c6'; ctx.beginPath(); ctx.arc(-r*0.35,-r*0.75,r*0.12,0,Math.PI*2); ctx.fill();

    // body
    ctx.fillStyle = altSkin ? '#fff5fb' : '#ffffff';
    roundRect(-r*0.9, r*0.6, r*1.8, r*1.2, r*0.3); ctx.fill();

    ctx.restore();
  }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  const game = {
    t:0, dt:0, last:0,
    score:0, wave:1, remaining:0,
    player:null, bullets:[], enemies:[], particles:[], boss:null, chest:null,
    running:false, victorySkin:false
  };

  function resetGame(){
    game.t=0; game.last=performance.now(); game.dt=0;
    game.score=0; game.wave=1; game.remaining=0;
    game.bullets.length=0; game.enemies.length=0; game.particles.length=0;
    game.boss=null; game.chest=null; game.victorySkin = LS.skin; // already unlocked?
    const alt = game.victorySkin;
    game.player = { x: W()/2, y: H()/2, r: 24*DPR, speed: 300*DPR, hp:5, cd:0, alt };
    spawnWave();
    hudUpdate();
  }

  function spawnWave(){
    const count = 6 + game.wave*2;
    game.remaining = count;
    for(let i=0;i<count;i++){
      const edge = Math.floor(Math.random()*4);
      let x,y;
      if(edge===0){ x=rand(50*DPR, W()-50*DPR); y=-40*DPR;}
      else if(edge===1){ x=W()+40*DPR; y=rand(50*DPR, H()-50*DPR);}
      else if(edge===2){ x=rand(50*DPR, W()-50*DPR); y=H()+40*DPR;}
      else{ x=-40*DPR; y=rand(50*DPR, H()-50*DPR);}
      game.enemies.push({x,y, r:16*DPR, hp:2+Math.floor(game.wave/2), speed: rand(60,100)*DPR, wob: rand(0,Math.PI*2)});
    }
    hudUpdate();
  }

  function spawnBoss(){
    const r = 60*DPR;
    game.boss = { x:W()/2, y:-r, r, hp: 120 + game.wave*20, hpMax: 120 + game.wave*20, phase:0, t:0 };
    state = STATE.BOSS;
    hud.bossbar.style.display='';
  }

  function spawnChest(){
    const r=28*DPR;
    game.chest = { x:W()/2, y:H()/2, r, open:false, t:0 };
  }

  function shoot(dirX, dirY){
    const p = game.player;
    if(p.cd>0) return;
    p.cd = 0.22; // cooldown
    const len = Math.hypot(dirX,dirY) || 1;
    const vx = (dirX/len) * 520*DPR;
    const vy = (dirY/len) * 520*DPR;
    game.bullets.push({x:p.x, y:p.y, r:10*DPR, vx, vy, t:0});
    beep({freq:720,type:'triangle',time:0.06});
  }

  function damagePlayer(dmg){
    const p = game.player;
    if(p.hp<=0) return;
    p.hp = Math.max(0, p.hp - dmg);
    for(let i=0;i<12;i++) particle(p.x, p.y, '#ff4d6d');
    beep({freq:200,type:'square',time:0.08,vol:0.2});
    if(p.hp===0) gameOver();
  }

  function damageEnemy(e, amount=1){
    e.hp -= amount;
    for(let i=0;i<8;i++) particle(e.x,e.y,'#ff88c6');
    if(e.hp<=0){
      game.score += 10;
      game.remaining = Math.max(0, game.remaining-1);
      for(let i=0;i<10;i++) particle(e.x,e.y,'#7ef5c9');
    }
  }

  function damageBoss(amount){
    const b = game.boss; if(!b) return;
    b.hp = Math.max(0, b.hp - amount);
    for(let i=0;i<12;i++) particle(b.x,b.y,'#ffd166');
    if(b.hp===0){
      game.score += 200;
      state = STATE.VICTORY;
      hud.bossbar.style.display='none';
      spawnChest();
      beep({freq:900,type:'sawtooth',time:0.12,vol:0.22});
    }
  }

  function particle(x,y,color='#ff69b4'){
    game.particles.push({x,y, vx:rand(-120,120)*DPR, vy:rand(-120,120)*DPR, life: rand(0.4,0.9), color});
  }

  // ===== Loop =====
  function loop(now){
    const dt = Math.min(0.033, (now - game.last)/1000);
    game.dt = dt; game.t += dt; game.last = now;
    update(dt); render();
    if(game.running) requestAnimationFrame(loop);
  }

  function update(dt){
    if(state===STATE.PLAY || state===STATE.BOSS || state===STATE.VICTORY){
      // player move
      const p = game.player;
      const dx = (keys['KeyD']||keys['ArrowRight']?1:0) - (keys['KeyA']||keys['ArrowLeft']?1:0) + jVec.x;
      const dy = (keys['KeyS']||keys['ArrowDown']?1:0) - (keys['KeyW']||keys['ArrowUp']?1:0) + jVec.y;
      const len = Math.hypot(dx,dy); 
      if(len>0){
        p.x += (dx/len) * p.speed * dt;
        p.y += (dy/len) * p.speed * dt;
      }
      p.x = clamp(p.x, p.r+6*DPR, W()-p.r-6*DPR);
      p.y = clamp(p.y, p.r+6*DPR, H()-p.r-6*DPR);
      if(p.cd>0) p.cd -= dt;

      // shooting
      const space = !!keys['Space'];
      if(space || attackPressed){
        // aim toward nearest enemy or boss or forward
        let tx=0, ty=0; let best=1e9;
        if(state===STATE.BOSS && game.boss){
          const b=game.boss; const d = Math.hypot(b.x-p.x,b.y-p.y); best=d; tx=b.x-p.x; ty=b.y-p.y;
        }
        for(const e of game.enemies){
          const d = Math.hypot(e.x-p.x, e.y-p.y);
          if(d<best){ best=d; tx=e.x-p.x; ty=e.y-p.y; }
        }
        if(best<1e9){ shoot(tx,ty); }
        else{ shoot(1,0); }
      }

      // bullets
      for(let i=game.bullets.length-1;i>=0;i--){
        const b = game.bullets[i];
        b.x += b.vx*dt; b.y += b.vy*dt; b.t+=dt;
        if(b.x<-40*DPR || b.x>W()+40*DPR || b.y<-40*DPR || b.y>H()+40*DPR || b.t>2.5){
          game.bullets.splice(i,1); continue;
        }
        // bullet vs enemies
        for(let j=game.enemies.length-1;j>=0;j--){
          const e = game.enemies[j];
          if(circleHit(b,e)){
            game.bullets.splice(i,1);
            damageEnemy(e,2);
            if(e.hp<=0) game.enemies.splice(j,1);
            break;
          }
        }
        // bullet vs boss
        if(state===STATE.BOSS && game.boss && circleHit(b, game.boss)){
          game.bullets.splice(i,1);
          damageBoss(3);
        }
      }

      // enemies
      for(let i=game.enemies.length-1;i>=0;i--){
        const e = game.enemies[i];
        e.wob += dt*3;
        const toP = Math.atan2(game.player.y - e.y, game.player.x - e.x);
        const speed = e.speed;
        e.x += Math.cos(toP)*speed*dt + Math.cos(e.wob)*30*DPR*dt;
        e.y += Math.sin(toP)*speed*dt + Math.sin(e.wob)*30*DPR*dt;

        // hit player
        if(circleHit(e, game.player)){
          game.enemies.splice(i,1);
          damagePlayer(1);
          continue;
        }
      }

      // wave -> boss
      if(state===STATE.PLAY && game.remaining===0 && game.enemies.length===0){
        spawnBoss();
      }

      // boss behavior
      if(state===STATE.BOSS && game.boss){
        const b = game.boss;
        b.t += dt;
        // enter
        if(b.y < H()*0.35) b.y += 120*DPR*dt;
        // phase bullets (simple star burst)
        if(b.t>1.2){
          b.t=0;
        
