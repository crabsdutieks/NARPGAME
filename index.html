<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>NARR DIVE ‚Äî Flappy Narwhal</title>
<style>
  :root{
    --bg1:#0a1e4b;
    --bg2:#0e2f7a;
    --aqua:#58fff1;
    --mint:#42ffd4;
    --pink:#ff82c5;
    --mango:#ffd166;
    --violet:#9b8cff;
    --seaweed:#1dd8a9;
    --coral:#ff6ea8;
    --mine:#173043;
    --mineEdge:#b8c7d4;
    --ink:#0a1220;
    --white:#f8fbff;
    --shadow:#06203b;
  }

  html,body{
    margin:0; padding:0; background:linear-gradient(180deg,var(--bg1),var(--bg2));
    height:100%; overflow:hidden; -webkit-tap-highlight-color:transparent;
    font-family: "Comic Sans MS","Trebuchet MS","Fredoka One","Baloo 2","Arial Rounded MT Bold",system-ui,sans-serif;
    color:var(--white);
  }
  #wrap{
    position:relative; width:100vw; height:100vh;
    display:grid; place-items:center;
  }
  canvas{ 
    width:100vw; height:100vh; display:block; 
    background:transparent;
    touch-action:none;
  }

  /* HUD */
  .hud{
    position:absolute; inset:0; pointer-events:none; 
    display:flex; flex-direction:column; justify-content:space-between;
    padding:12px;
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 14px rgba(0,0,0,.25);
  }
  .score{
    font-size: clamp(24px, 6vw, 54px);
    font-weight:900; letter-spacing:1px;
    color:var(--mango);
    filter: drop-shadow(0 3px 0 rgba(0,0,0,.35));
  }
  .best{
    font-size: clamp(12px, 2.4vw, 18px);
    opacity:.9;
  }
  .corner{
    display:flex; gap:8px; pointer-events:auto;
  }
  .btn{
    border:none; border-radius:16px; padding:10px 14px; font-weight:900; cursor:pointer;
    background:linear-gradient(180deg,#1fd3b1,#0ab89a);
    box-shadow:0 6px 0 #0a836c, 0 14px 20px rgba(0,0,0,.25);
    color:#062b2d; text-transform:uppercase; letter-spacing:.5px;
    transition:transform .06s ease, box-shadow .06s ease, filter .12s ease;
    user-select:none;
  }
  .btn:active{ transform:translateY(3px); box-shadow:0 3px 0 #0a836c, 0 8px 14px rgba(0,0,0,.25);}
  .btn.alt{ background:linear-gradient(180deg,#7fa7ff,#6878ff); box-shadow:0 6px 0 #4653c7;}
  .btn.warn{ background:linear-gradient(180deg,#ff8aa1,#ff6a88); box-shadow:0 6px 0 #c74360; color:#441118;}
  .pill{
    background:rgba(255,255,255,.1); padding:6px 10px; border-radius:999px; font-weight:700;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);
  }

  /* Screens */
  .screen{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,.08), rgba(0,0,0,.25) 60%, rgba(0,0,0,.5) 100%);
    backdrop-filter: blur(4px);
  }
  .card{
    width:min(92vw,680px); max-width:680px;
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border-radius:28px; padding:24px; box-shadow: 0 18px 60px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.12);
  }
  .title{
    font-size: clamp(28px, 8vw, 64px); line-height:1; margin:0 0 10px;
    color:var(--aqua); text-shadow: 0 4px 0 #053144, 0 0 24px rgba(88,255,241,.5);
  }
  .subtitle{ margin:0 0 14px; color: #cfefff; opacity:.95; font-weight:700; letter-spacing:.5px;}
  .grid{ display:grid; gap:12px;}
  .grid.cols-2{ grid-template-columns:1fr 1fr; }
  .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
  .label{ font-weight:800; text-transform:uppercase; opacity:.9;}
  .range{ width:100%; }
  .select{
    appearance:none; background:rgba(255,255,255,.12); border:none; color:var(--white);
    padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);
  }
  .small{ font-size:.9rem; opacity:.85; }
  .center{ text-align:center; }

  .hidden{ display:none !important; }

  /* Mobile UX nits */
  @media (hover:none){
    .btn { padding:14px 16px; border-radius:18px; }
  }
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" aria-label="NARR DIVE game canvas" role="img"></canvas>

    <!-- HUD -->
    <div class="hud" aria-hidden="false">
      <div class="topbar">
        <div>
          <div class="score" id="score">0</div>
          <div class="best">Best: <span id="bestScore">0</span></div>
        </div>
        <div class="corner">
          <button id="btnPause" class="btn alt" aria-label="Pause">Pause</button>
          <button id="btnMute" class="btn" aria-label="Mute">üîä</button>
        </div>
      </div>
      <div class="bottom" style="display:flex; justify-content:space-between; align-items:flex-end;">
        <div class="pill">Tap / Click / Space = Dash ‚Üë</div>
        <div class="pill">P = Pause</div>
      </div>
    </div>

    <!-- Screens -->
    <section id="screenMenu" class="screen" aria-modal="true">
      <div class="card">
        <h1 class="title">NARR DIVE</h1>
        <p class="subtitle">Narwhal vs. Glaciers &amp; Mines ‚Äî Swim the gaps, dodge the spikes, claim the ocean.</p>
        <div class="grid cols-2">
          <button id="playBtn" class="btn" style="font-size:1.25rem;">‚ñ∂ Jouer</button>
          <button id="optsBtn" class="btn alt">‚öô Options</button>
        </div>
        <div class="grid" style="margin-top:12px;">
          <div class="row"><span class="label">Contr√¥les</span><span class="small">Espace / Clic / Touch</span></div>
          <div class="row"><span class="label">Objectif</span><span class="small">Passe les obstacles, +1 par portail</span></div>
          <div class="row"><span class="label">Tip</span><span class="small">Tap courts &amp; r√©guliers ‚â´ stabilit√©</span></div>
        </div>
      </div>
    </section>

    <section id="screenOptions" class="screen hidden" aria-modal="true">
      <div class="card">
        <h2 class="title" style="font-size:clamp(24px,6vw,44px);">Options</h2>
        <div class="grid">
          <div class="row">
            <span class="label">Difficult√©</span>
            <select id="difficulty" class="select">
              <option value="easy">Easy</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="row">
            <span class="label">Musique</span>
            <input id="musicVol" type="range" min="0" max="1" step="0.01" class="range">
          </div>
          <div class="row">
            <span class="label">SFX</span>
            <input id="sfxVol" type="range" min="0" max="1" step="0.01" class="range">
          </div>
          <div class="row">
            <span class="label">Mode Particules</span>
            <select id="particles" class="select">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:12px;">
          <button id="backBtn" class="btn alt">‚Üê Retour</button>
          <button id="saveOpts" class="btn">üíæ Sauver</button>
        </div>
      </div>
    </section>

    <section id="screenPause" class="screen hidden" aria-live="polite">
      <div class="card center">
        <h2 class="title" style="font-size:clamp(24px,6vw,44px);">Pause</h2>
        <p class="subtitle">Respire‚Ä¶ l‚Äôoc√©an attend.</p>
        <div class="grid cols-2">
          <button id="resumeBtn" class="btn">‚ñ∂ Reprendre</button>
          <button id="quitBtn" class="btn warn">‚èª Quitter</button>
        </div>
      </div>
    </section>

    <section id="screenOver" class="screen hidden" aria-live="polite">
      <div class="card center">
        <h2 class="title" style="font-size:clamp(24px,6vw,44px); color:var(--coral)">Game Over</h2>
        <p class="subtitle">Score: <span id="finalScore">0</span> ‚Äî Best: <span id="finalBest">0</span></p>
        <div class="grid cols-2">
          <button id="restartBtn" class="btn">‚Üª Rejouer</button>
          <button id="overOptsBtn" class="btn alt">‚öô Options</button>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  'use strict';

  /***********************
   * Utility & Settings  *
   ***********************/
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const rand = (a,b)=> Math.random()*(b-a)+a;
  const lerp = (a,b,t)=> a+(b-a)*t;
  const now = ()=> performance.now();

  const STORAGE_KEY = 'NARR_DIVE_SAVE';
  const defaultSave = {
    best: 0,
    opts: { difficulty:'normal', music:0.6, sfx:0.9, particles:'medium', muted:false }
  };
  let SAVE = loadSave();

  function loadSave(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultSave);
      const parsed = JSON.parse(raw);
      return { ...structuredClone(defaultSave), ...parsed, opts: { ...defaultSave.opts, ...(parsed.opts||{}) } };
    }catch(e){ console.warn('Save load failed', e); return structuredClone(defaultSave); }
  }
  function commitSave(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(SAVE)); }catch(e){} }

  /***********************
   * Canvas Setup        *
   ***********************/
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d',{ alpha:true, desynchronized:true });
  let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  // Internal logical size: 480x800 (portrait-first, scales to landscape)
  const LOGICAL = { w:480, h:800 };
  let view = { w: window.innerWidth, h: window.innerHeight };
  function resize(){
    view.w = window.innerWidth; view.h = window.innerHeight;
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    canvas.width = Math.round(view.w * DPR);
    canvas.height = Math.round(view.h * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  /***********************
   * Audio (WebAudio)    *
   ***********************/
  let AC = null;
  function ensureAC(){
    if(AC) return AC;
    const ACCls = window.AudioContext || window.webkitAudioContext;
    if(!ACCls) return null;
    AC = new ACCls();
    // iOS: resume on gesture
    if(AC.state === 'suspended'){ AC.resume?.(); }
    return AC;
  }

  const AudioSys = {
    musicGain:null, sfxGain:null, masterGain:null, seqInt:null, bpm:102,
    init(){
      const ac = ensureAC(); if(!ac) return;
      this.masterGain = ac.createGain();
      this.musicGain = ac.createGain();
      this.sfxGain   = ac.createGain();
      this.musicGain.gain.value = SAVE.opts.muted?0:SAVE.opts.music;
      this.sfxGain.gain.value   = SAVE.opts.muted?0:SAVE.opts.sfx;
      this.masterGain.connect(ac.destination);
      this.musicGain.connect(this.masterGain);
      this.sfxGain.connect(this.masterGain);
    },
    setMusicVol(v){ if(!this.musicGain) return; this.musicGain.gain.value = SAVE.opts.muted?0:v; },
    setSfxVol(v){ if(!this.sfxGain) return; this.sfxGain.gain.value = SAVE.opts.muted?0:v; },
    setMuted(m){ if(!this.musicGain||!this.sfxGain) return; if(m){ this.musicGain.gain.value=0; this.sfxGain.gain.value=0; } else { this.setMusicVol(SAVE.opts.music); this.setSfxVol(SAVE.opts.sfx); } },
    play(beep){ // tiny procedural SFX
      const ac = ensureAC(); if(!ac) return;
      const nowt = ac.currentTime;
      switch(beep){
        case 'flap':{
          const o=ac.createOscillator(), g=ac.createGain();
          o.type='triangle'; o.frequency.setValueAtTime(620,nowt); o.frequency.exponentialRampToValueAtTime(420, nowt+0.08);
          g.gain.setValueAtTime(0.0001,nowt); g.gain.exponentialRampToValueAtTime(0.2, nowt+0.01); g.gain.exponentialRampToValueAtTime(0.0001, nowt+0.12);
          o.connect(g).connect(this.sfxGain); o.start(nowt); o.stop(nowt+0.14);
        }break;
        case 'score':{
          const o=ac.createOscillator(), g=ac.createGain();
          o.type='square'; o.frequency.setValueAtTime(880,nowt); o.frequency.exponentialRampToValueAtTime(1320, nowt+0.06);
          g.gain.setValueAtTime(0.0001,nowt); g.gain.exponentialRampToValueAtTime(0.25, nowt+0.02); g.gain.exponentialRampToValueAtTime(0.0001, nowt+0.12);
          o.connect(g).connect(this.sfxGain); o.start(nowt); o.stop(nowt+0.13);
        }break;
        case 'hit':{
          const b=ac.createBuffer(1, ac.sampleRate*0.25, ac.sampleRate);
          const data=b.getChannelData(0);
          for(let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2); }
          const n=ac.createBufferSource(); const g=ac.createGain();
          g.gain.setValueAtTime(0.25, nowt); g.gain.exponentialRampToValueAtTime(0.0001, nowt+0.25);
          n.buffer=b; n.connect(g).connect(this.sfxGain); n.start(nowt);
        }break;
        case 'btn':{
          const o=ac.createOscillator(), g=ac.createGain();
          o.type='sine'; o.frequency.setValueAtTime(660,nowt); o.frequency.exponentialRampToValueAtTime(520, nowt+0.06);
          g.gain.setValueAtTime(0.0001,nowt); g.gain.exponentialRampToValueAtTime(0.22, nowt+0.02); g.gain.exponentialRampToValueAtTime(0.0001, nowt+0.10);
          o.connect(g).connect(this.sfxGain); o.start(nowt); o.stop(nowt+0.11);
        }break;
      }
    },
    startMusic(){
      const ac = ensureAC(); if(!ac) return;
      if(this.seqInt) return; // already running
      const seq = [
        440,440,523,440,659,587,523,392,
        440,440,523,440,698,659,587,523
      ]; // simple cheerful loop
      const stepDur = 60/this.bpm; // seconds per beat
      let i=0;
      this.seqInt = setInterval(()=>{
        const o=ac.createOscillator(); const g=ac.createGain();
        o.type='triangle';
        o.frequency.value = seq[i%seq.length];
        const t=ac.currentTime;
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.15, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+stepDur*0.9);
        o.connect(g).connect(this.musicGain);
        o.start(t); o.stop(t+stepDur);
        i++;
      }, stepDur*1000);
    },
    stopMusic(){ if(this.seqInt){ clearInterval(this.seqInt); this.seqInt=null; } }
  };

  /***********************
   * Game State          *
   ***********************/
  const SCREENS = {
    menu: document.getElementById('screenMenu'),
    options: document.getElementById('screenOptions'),
    pause: document.getElementById('screenPause'),
    over: document.getElementById('screenOver')
  };
  const HUD = {
    score: document.getElementById('score'),
    best: document.getElementById('bestScore'),
    final: document.getElementById('finalScore'),
    finalBest: document.getElementById('finalBest'),
    btnPause: document.getElementById('btnPause'),
    btnMute: document.getElementById('btnMute')
  };
  const OPTW = {
    diff: document.getElementById('difficulty'),
    music: document.getElementById('musicVol'),
    sfx: document.getElementById('sfxVol'),
    particles: document.getElementById('particles'),
    play: document.getElementById('playBtn'),
    opts: document.getElementById('optsBtn'),
    back: document.getElementById('backBtn'),
    save: document.getElementById('saveOpts'),
    resume: document.getElementById('resumeBtn'),
    quit: document.getElementById('quitBtn'),
    restart: document.getElementById('restartBtn'),
    overOpts: document.getElementById('overOptsBtn')
  };

  HUD.best.textContent = SAVE.best|0;

  let state = 'menu'; // menu|playing|paused|over
  function showScreen(name){
    for(const key in SCREENS){ SCREENS[key].classList.add('hidden'); }
    if(name && SCREENS[name]) SCREENS[name].classList.remove('hidden');
  }
  showScreen('menu');

  /***********************
   * Input               *
   ***********************/
  const Input = { tap:false, pressed:false };
  function onPress(e){ e.preventDefault(); Input.tap = true; Input.pressed = true; }
  function onRelease(e){ e.preventDefault(); Input.pressed = false; }
  window.addEventListener('mousedown', onPress);
  window.addEventListener('mouseup', onRelease);
  window.addEventListener('touchstart', onPress, {passive:false});
  window.addEventListener('touchend', onRelease);
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ onPress(e); }
    if(e.code==='KeyP'){ togglePause(); }
  });
  window.addEventListener('keyup', (e)=>{ if(e.code==='Space'){ onRelease(e);} });

  /***********************
   * World & Entities    *
   ***********************/
  const WORLD = {
    w: LOGICAL.w, h: LOGICAL.h,
    speed: 170, // base horizontal speed
    gravity: 1700, // px/s^2
    flap: 470, // impulse
    gap: 210,  // vertical gap
    spawnEvery: 1.45, // seconds
    mineChance: 0.5
  };

  function applyDifficulty(){
    const d = SAVE.opts.difficulty;
    if(d==='easy'){ WORLD.speed=150; WORLD.gap=240; WORLD.spawnEvery=1.6; WORLD.mineChance=0.35; }
    else if(d==='hard'){ WORLD.speed=195; WORLD.gap=180; WORLD.spawnEvery=1.25; WORLD.mineChance=0.65; }
    else { WORLD.speed=170; WORLD.gap=210; WORLD.spawnEvery=1.45; WORLD.mineChance=0.5; }
  }
  applyDifficulty();

  const player = {
    x: WORLD.w*0.28, y: WORLD.h*0.5,
    vy: 0,
    r: 22,
    alive:true,
    rot:0
  };

  const obstacles = []; // { x, w, gapY, passed, topH, bottomY, mine? {x,y,r,phase} }
  let spawnTimer = 0;
  let score = 0;
  let lastTime = now();
  let particles = [];
  const particleBudget = ()=> ({high:220,medium:140,low:80,off:0}[SAVE.opts.particles||'medium']);

  function resetGame(){
    player.x = WORLD.w*0.28; player.y = WORLD.h*0.5; player.vy=0; player.alive=true; player.rot=0;
    obstacles.length=0; particles.length=0; score=0; spawnTimer=0;
    HUD.score.textContent = '0';
  }

  function spawnObstacle(){
    const w = 86;
    const padTop = 40, padBottom = 80;
    const maxY = WORLD.h - padBottom - WORLD.gap;
    const gapY = rand(padTop, maxY);
    const x = WORLD.w + 30;
    const topH = gapY;
    const bottomY = gapY + WORLD.gap;
    const obj = { x, w, gapY, passed:false, topH, bottomY, mine:null, mine2:null };
    // random mines between or around
    if(Math.random() < WORLD.mineChance){
      const rr = rand(16,24);
      obj.mine = {
        x: x + w*0.5,
        y: gapY + WORLD.gap*0.5 + rand(-WORLD.gap*0.25, WORLD.gap*0.25),
        r: rr, phase: Math.random()*Math.PI*2, amp: rand(8,18), speed: rand(0.8,1.6)
      };
      if(Math.random()<0.35){
        obj.mine2 = {
          x: x + w + rand(20,48),
          y: gapY + WORLD.gap*0.5 + rand(-WORLD.gap*0.25, WORLD.gap*0.25),
          r: rand(12,18), phase: Math.random()*Math.PI*2, amp: rand(6,14), speed: rand(1.2,1.9)
        };
      }
    }
    obstacles.push(obj);
  }

  /***********************
   * Rendering           *
   ***********************/
  function drawBackground(dt, t){
    // Sea gradient already on body; draw parallax: distant mountains of ice, bubbles, light rays
    const w = view.w, h = view.h;
    ctx.save();

    // Light rays
    for(let i=0;i<6;i++){
      const x = ((t*10 + i*240) % (w+240)) - 240;
      const grd = ctx.createLinearGradient(x,0,x+240,h);
      grd.addColorStop(0,'rgba(255,255,255,0.03)');
      grd.addColorStop(1,'rgba(255,255,255,0.00)');
      ctx.fillStyle = grd;
      ctx.fillRect(x,0,240,h);
    }

    // Far ice silhouettes
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = '#bde7ff';
    const yBase = h*0.18;
    for(let i=0;i<4;i++){
      const ox = ((-t*20) + i*(w/3)) % (w+200) - 200;
      ctx.beginPath();
      ctx.moveTo(ox, yBase);
      ctx.lineTo(ox+80, yBase-18);
      ctx.lineTo(ox+140, yBase);
      ctx.lineTo(ox+200, yBase-12);
      ctx.lineTo(ox+260, yBase);
      ctx.lineTo(ox+260, yBase+26);
      ctx.lineTo(ox, yBase+26);
      ctx.closePath();
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // Caustics strips
    for(let i=0;i<3;i++){
      const yy = h*0.55 + Math.
