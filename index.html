<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>NARR DIVE ‚Äî Flappy Narwhal</title>
<style>
  :root{
    --bg1:#092047; --bg2:#0e2f7a;
    --ink:#072034; --white:#f8fbff;
    --aqua:#58fff1; --mint:#42ffd4; --mango:#ffd166;
    --coral:#ff6ea8; --ice:#bde7ff; --ice2:#e9f7ff;
    --seaweed:#0b8b6a; --seaweedDark:#066651;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--white);
    font-family:"Comic Sans MS","Arial Rounded MT Bold","Trebuchet MS",system-ui,sans-serif;overflow:hidden;-webkit-tap-highlight-color:transparent}
  #wrap{position:relative;width:100vw;height:100vh}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:transparent;z-index:1;touch-action:none}

  /* HUD */
  .hud{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:12px;z-index:3;pointer-events:none}
  .row{display:flex;justify-content:space-between;align-items:center}
  .score{font-size:clamp(28px,6vw,60px);font-weight:900;color:var(--mango);
    text-shadow:0 3px 0 rgba(0,0,0,.35), 0 0 14px rgba(0,0,0,.25); letter-spacing:.5px}
  .best{opacity:.95;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .hud .right{display:flex;gap:8px;pointer-events:auto}

  /* Buttons (cartoon) */
  .btn{border:none;border-radius:18px;padding:12px 16px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;
       background:linear-gradient(180deg,#22d6b7,#09b59a);box-shadow:0 6px 0 #0a836c,0 14px 20px rgba(0,0,0,.25);color:#053d3b}
  .btn:active{transform:translateY(3px);box-shadow:0 3px 0 #0a836c,0 8px 14px rgba(0,0,0,.25)}
  .btn.alt{background:linear-gradient(180deg,#7fa7ff,#6878ff);box-shadow:0 6px 0 #4653c7;color:#eef2ff}
  .btn.warn{background:linear-gradient(180deg,#ff8aa1,#ff6a88);box-shadow:0 6px 0 #c74360;color:#441118}

  .pill{pointer-events:none;background:rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-weight:900;letter-spacing:.3px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.16)}

  /* Screens */
  .screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:5;
    background:radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,.08), rgba(0,0,0,.42) 60%, rgba(0,0,0,.6) 100%);
    backdrop-filter:blur(4px)}
  .hidden{display:none!important}
  .card{width:min(92vw,720px);background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.08));
    border-radius:30px;padding:26px;box-shadow:0 18px 60px rgba(0,0,0,.45), inset 0 0 0 3px rgba(255,255,255,.12)}
  .title{font-size:clamp(30px,8vw,64px);margin:0 0 8px;color:var(--aqua);
    text-shadow:0 4px 0 #053144, 0 0 22px rgba(88,255,241,.5); letter-spacing:1px}
  .subtitle{margin:0 0 14px;color:#dff7ff;font-weight:900;letter-spacing:.6px;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px}.cols-2{grid-template-columns:1fr 1fr}
  .select,.range{appearance:none;background:rgba(255,255,255,.14);color:var(--white);border:none;border-radius:14px;padding:10px 12px;font-weight:900}

  /* Game Over */
  .overScore{font-size:clamp(36px,8vw,72px);font-weight:900;color:var(--mango);
    text-shadow:0 4px 0 rgba(0,0,0,.4),0 0 22px rgba(255,209,102,.45); margin:10px 0}
  .overBest{font-size:clamp(16px,4vw,22px); opacity:.95; font-weight:800}
  .confetti{position:absolute;inset:0;pointer-events:none;z-index:7}
  @media(hover:none){ .btn{ padding:14px 18px; border-radius:20px } }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" aria-label="NARR DIVE game canvas"></canvas>

  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="row">
      <div>
        <div class="score" id="score">0</div>
        <div class="best">Best: <span id="best">0</span></div>
      </div>
      <div class="right">
        <button id="pauseBtn" class="btn alt" type="button">Pause</button>
        <button id="muteBtn" class="btn" type="button">üîä</button>
      </div>
    </div>
    <div class="row" style="padding:2px 4px">
      <div class="pill">Tap / Click / Space = Jump</div>
      <div class="pill">P = Pause</div>
    </div>
  </div>

  <!-- MENU -->
  <section id="menu" class="screen">
    <div class="card">
      <h1 class="title">$NARR ‚Äî NARR DIVE</h1>
      <p class="subtitle">Dive with <b>Narr the Narwhal</b> through shifting ice caves, dodge mines, grab glowing pearls, and ride the current. Smooth, catchy, endlessly replayable.</p>
      <div class="grid cols-2" style="margin-bottom:10px">
        <button id="playBtn" class="btn" type="button">‚ñ∂ Play</button>
        <button id="optsBtn" class="btn alt" type="button">‚öô Options</button>
      </div>
      <div class="grid">
        <div class="row"><span style="font-weight:900">Controls</span><span>Space / Click / Tap</span></div>
        <div class="row"><span style="font-weight:900">Goal</span><span>Advance to score; pearls = bonus!</span></div>
      </div>
    </div>
  </section>

  <!-- OPTIONS -->
  <section id="options" class="screen hidden">
    <div class="card">
      <h2 class="title" style="font-size:clamp(24px,6vw,42px)">Options</h2>
      <div class="grid">
        <div class="row"><span class="subtitle" style="font-size:18px;margin:0">Music</span><input id="music" class="range" type="range" min="0" max="1" step="0.01"></div>
        <div class="row"><span class="subtitle" style="font-size:18px;margin:0">SFX</span><input id="sfx" class="range" type="range" min="0" max="1" step="0.01"></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <button id="backBtn" class="btn alt" type="button">‚Üê Back</button>
        <button id="saveBtn" class="btn" type="button">üíæ Save</button>
      </div>
    </div>
  </section>

  <!-- PAUSE -->
  <section id="pause" class="screen hidden">
    <div class="card" style="text-align:center">
      <h2 class="title" style="font-size:clamp(24px,6vw,42px)">Paused</h2>
      <p class="subtitle">Take a breath‚Ä¶</p>
      <div class="grid cols-2">
        <button id="resumeBtn" class="btn" type="button">‚ñ∂ Resume</button>
        <button id="quitBtn" class="btn warn" type="button">‚èª Quit</button>
      </div>
    </div>
  </section>

  <!-- GAME OVER -->
  <section id="over" class="screen hidden">
    <div class="card" style="text-align:center; position:relative; overflow:hidden;">
      <h2 class="title" style="font-size:clamp(26px,6vw,48px); color:var(--coral); text-shadow:0 4px 0 rgba(0,0,0,.4)">Game Over</h2>
      <div class="overScore">Score: <span id="finalScore">0</span></div>
      <div class="overBest">Best: <span id="finalBest">0</span></div>
      <p class="subtitle" id="overMsg" style="margin-top:8px">Smooth swim! Try for a new best.</p>
      <div class="grid cols-2" style="margin-top:12px">
        <button id="restartBtn" class="btn" type="button">‚Üª Restart</button>
        <button id="overOptsBtn" class="btn alt" type="button">‚öô Options</button>
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <button id="tweetBtn" class="btn" type="button">Share on X (Twitter)</button>
        <button id="submitScoreBtn" class="btn alt" type="button">Submit to Leaderboard</button>
      </div>
      <canvas id="confetti" class="confetti"></canvas>
    </div>
  </section>
</div>

<script>
(() => {
  'use strict';

  /* =================== CONFIG (edit if you add backend) =================== */
  const GAME_VERSION = '1.3.0';
  const GAME_URL = location.origin + location.pathname; // link in tweets
  const SCORE_API = null; // e.g. 'https://api.yourdomain.com/narr'
  // Backend protocol (summary):
  // 1) POST SCORE_API + '/session'  -> { session:string, seed:uint32 }
  // 2) Client plays using that seed, recording inputs [{t,type:'tap'}] and duration.
  // 3) POST SCORE_API + '/submit'   -> body { session, version, score, durationMs, seed, inputs:[...], meta:{w,h,ts} }
  // Server re-simulates deterministically and rejects tampered runs. Weekly winners = top verified scores in time window.

  /* ======================= Shortcuts & Deterministic RNG ======================= */
  const $ = id => document.getElementById(id);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  // Deterministic RNG (mulberry32)
  function makeRng(seed){ let a=seed>>>0; return ()=>{ a|=0; a=(a+0x6D2B79F5)|0; let t=Math.imul(a^(a>>>15),1|a); t=(t+Math.imul(t^(t>>>7),61|t))^t; return ((t^(t>>>14))>>>0)/4294967296; }; }
  let SEED = 123456789, RNG = makeRng(SEED);
  const R = (min,max)=> RNG()*(max-min)+min;
  const Rint = (min,max)=> (R(min,max)|0);
  const Rchance = (p)=> RNG()<p;

  /* =============================== Save =============================== */
  const STORAGE='NARR_DIVE_SAVE_V4';
  const DEFAULT={ best:0, opts:{ music:0.7, sfx:0.9, muted:false } };
  let SAVE = (()=>{ try{ const r=localStorage.getItem(STORAGE); if(!r) return JSON.parse(JSON.stringify(DEFAULT));
    const p=JSON.parse(r); return { ...DEFAULT, ...p, opts:{...DEFAULT.opts, ...(p.opts||{}) } }; }catch(_){ return JSON.parse(JSON.stringify(DEFAULT)); }})();
  const commit = ()=>{ try{ localStorage.setItem(STORAGE, JSON.stringify(SAVE)); }catch(_){ } };

  /* ============================== Canvas ============================== */
  const canvas = $('game');
  const ctx = canvas.getContext('2d', { alpha:true });
  let DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
  const view = { w: innerWidth, h: innerHeight };
  function resize(){ view.w=innerWidth; view.h=innerHeight; DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
    canvas.width=Math.round(view.w*DPR); canvas.height=Math.round(view.h*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
  addEventListener('resize', resize, {passive:true}); resize();

  /* ============================== Music & SFX ============================== */
  // Cooler track: chord pad + arpeggio + bass + simple kick/snare-ish ticks
  let AC=null, gMaster=null, gMusic=null, gSfx=null, musicClock=null;
  const Music={
    step:0, tempo:92, // bpm
    chordIdx:0,
    chords:[[0,7,12,16],[2,9,14,19],[5,12,17,21],[4,11,16,21]], // relative semitones
    baseNote:220, // A3
    init(){
      try{
        const C=window.AudioContext||window.webkitAudioContext; if(!C) return;
        AC=AC||new C();
        gMaster=AC.createGain(); gMusic=AC.createGain(); gSfx=AC.createGain();
        gMusic.gain.value = SAVE.opts.muted?0:SAVE.opts.music;
        gSfx.gain.value = SAVE.opts.muted?0:SAVE.opts.sfx;
        gMusic.connect(gMaster); gSfx.connect(gMaster); gMaster.connect(AC.destination);
      }catch(_){}
    },
    hzFromSemi(base,semi){ return base*Math.pow(2,semi/12); },
    tone(freq, dur, type='sine', gain=0.15, out=gMusic){
      if(!AC) return;
      const t=AC.currentTime;
      const o=AC.createOscillator(), g=AC.createGain();
      o.type=type; o.frequency.value=freq;
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(gain,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur*0.95);
      o.connect(g).connect(out); o.start(t); o.stop(t+dur);
    },
    noiseSnare(dur=0.08, gain=0.12){
      if(!AC) return;
      const b=AC.createBuffer(1, AC.sampleRate*dur, AC.sampleRate);
      const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2);
      const n=AC.createBufferSource(), g=AC.createGain(); g.gain.value=gain;
      n.buffer=b; n.connect(g).connect(gMusic); n.start();
    },
    kick(freq=90, dur=0.16, gain=0.25){
      if(!AC) return;
      const t=AC.currentTime;
      const o=AC.createOscillator(), g=AC.createGain();
      o.type='sine'; o.frequency.setValueAtTime(freq,t); o.frequency.exponentialRampToValueAtTime(40,t+dur);
      g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(gain,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      o.connect(g).connect(gMusic); o.start(t); o.stop(t+dur);
    },
    start(){
      if(!AC||musicClock) return;
      const spb=60/this.tempo; const sixteenth=spb/4;
      musicClock=setInterval(()=>{ try{
        const s=this.step++%64;
        // chord pad every bar (attack then fade)
        if(s%16===0){
          const chord=this.chords[this.chordIdx++%this.chords.length];
          chord.forEach((semi,i)=> this.tone(this.hzFromSemi(this.baseNote,semi), 0.8, 'triangle', 0.06*(i<2?1:0.8)));
        }
        // arpeggio on 16th
        const arpSemi=[0,7,12,16,12,7,0,7][s%8];
        this.tone(this.hzFromSemi(this.baseNote,arpSemi+12), 0.12, 'sawtooth', 0.045);
        // bass on 8ths
        if(s%2===0){
          const bassSemi=[0,0,2,2,5,5,4,4][Math.floor(s/8)%8];
          this.tone(this.hzFromSemi(this.baseNote/2,bassSemi), 0.18,'sine',0.09);
        }
        // kick/snare grid
        if(s%4===0) this.kick();
        if(s%8===4) this.noiseSnare();
      }catch(_){ } }, sixteenth*1000);
    },
    stop(){ if(musicClock){ clearInterval(musicClock); musicClock=null; } },
    setMuted(m){ if(!gMusic||!gSfx) return; gMusic.gain.value=m?0:SAVE.opts.music; gSfx.gain.value=m?0:SAVE.opts.sfx; },
    setMusic(v){ if(gMusic) gMusic.gain.value=SAVE.opts.muted?0:v; },
    setSfx(v){ if(gSfx) gSfx.gain.value=SAVE.opts.muted?0:v; }
  };
  function sfx(type){
    if(!AC||!gSfx) return;
    const t=AC.currentTime;
    if(type==='flap'){
      const o=AC.createOscillator(), g=AC.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(620,t); o.frequency.exponentialRampToValueAtTime(420,t+0.08);
      g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.22,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
      o.connect(g).connect(gSfx); o.start(t); o.stop(t+0.14);
    } else if(type==='coin'){
      const o=AC.createOscillator(), g=AC.createGain();
      o.type='square'; o.frequency.setValueAtTime(1200,t); o.frequency.exponentialRampToValueAtTime(1680,t+0.06);
      g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.28,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
      o.connect(g).connect(gSfx); o.start(t); o.stop(t+0.13);
    } else if(type==='hit'){
      const b=AC.createBuffer(1, AC.sampleRate*0.25, AC.sampleRate), d=b.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length);
      const n=AC.createBufferSource(), g=AC.createGain(); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.25);
      n.buffer=b; n.connect(g).connect(gSfx); n.start(t);
    }
  }

  /* ============================ UI refs ============================ */
  const screenMenu=$('menu'), screenOptions=$('options'), screenPause=$('pause'), screenOver=$('over');
  const playBtn=$('playBtn'), optsBtn=$('optsBtn'), backBtn=$('backBtn'), saveBtn=$('saveBtn');
  const pauseBtn=$('pauseBtn'), muteBtn=$('muteBtn'), resumeBtn=$('resumeBtn'), quitBtn=$('quitBtn');
  const restartBtn=$('restartBtn'), overOptsBtn=$('overOptsBtn'), tweetBtn=$('tweetBtn'), submitScoreBtn=$('submitScoreBtn');
  const scoreEl=$('score'), bestEl=$('best'), finalScoreEl=$('finalScore'), finalBestEl=$('finalBest'), overMsg=$('overMsg');
  const rngMusic=$('music'), rngSfx=$('sfx'); bestEl.textContent=SAVE.best|0;

  /* ======================= Game state & params ======================= */
  const WORLD={
    baseSpeed:150, speed:150, maxSpeed:275, accel:2.1,
    gravity:1800, flap:480,
    gapBase:240, gapVar:0.30,
    spawnMin:1.15, spawnMax:1.65,
    mineChance:0.55, coinChance:0.85
  };

  const player={ x:0, y:0, vy:0, r:22, alive:true, rot:0 };
  const obstacles=[]; // {x,w,topH,bottomY,phase}
  const coins=[];     // {x,y,r,spin}
  const mines=[];     // {x,y,r,phase,speed}
  const poofs=[];     // particles
  const fish=[];      // background fish

  let spawnTimer=0, score=0, running=false, state='menu', last=performance.now();
  let distAccum=0; const DIST_PER_POINT=120; const COIN_BONUS=10;

  /* ==================== Replay for anti-cheat ==================== */
  let session=null;            // from backend
  let startEpoch=0;            // ms timestamp
  let replayInputs=[];         // [{t:ms,type:'tap'}]
  function recordTap(){ if(state==='playing') replayInputs.push({t:Date.now()-startEpoch, type:'tap'}); }
  function buildSubmission(){
    return {
      session, version:GAME_VERSION,
      url: GAME_URL,
      score, durationMs: Date.now()-startEpoch,
      seed: SEED>>>0,
      inputs: replayInputs.slice(0, 20000), // cap
      meta:{ w:view.w, h:view.h, ts:startEpoch }
    };
  }

  /* ========================= Spawners ========================= */
  function spawnObstacle(){
    const w = Math.max(70, Math.min(120, view.w*0.18)) * (0.9 + RNG()*0.25);
    const padTop = 50, padBottom = 90;
    const gap = WORLD.gapBase * (view.h/800) * (1 + (RNG()*2-1)*WORLD.gapVar);
    const maxY = view.h - padBottom - gap;
    const gapTop = R( padTop, maxY );
    const x = view.w + w;
    const phase = RNG()*Math.PI*2;
    obstacles.push({ x, w, topH:gapTop, bottomY:gapTop+gap, phase });

    if(Rchance(WORLD.coinChance)){
      const count = Rchance(0.5) ? 1 : 3;
      for(let i=0;i<count;i++){
        const yy = gapTop + gap*0.2 + i*(gap*0.6/Math.max(1,count-1));
        coins.push({ x:x + w*0.5 + i*24, y:yy, r: Math.max(12, view.w*0.025), spin: RNG()*Math.PI*2 });
      }
    }
    if(Rchance(WORLD.mineChance)){
      const mcount = Rchance(0.7) ? 1 : 2;
      for(let i=0;i<mcount;i++){
        const my = gapTop + gap*0.5 + R(-gap*0.25, gap*0.25);
        const mx = x + w + R(30,70) + i*R(20,50);
        mines.push({ x:mx, y:my, r: Math.max(16, view.w*0.03), phase: RNG()*Math.PI*2, speed: R(0.8,1.6) });
      }
    }
    spawnTimer = R(WORLD.spawnMin, WORLD.spawnMax);
  }

  /* ====================== Background life ====================== */
  function seedFish(){
    const count = 10;
    for(let i=0;i<count;i++){
      fish.push({ x:R(0,view.w), y:R(view.h*0.25, view.h*0.85), s:R(20,50), v:R(20,60), t:R(0,6.28) });
    }
  }
  function drawFish(dt,t){
    ctx.fillStyle='rgba(255,255,255,0.65)';
    for(const f of fish){
      f.t += dt*f.v*0.02;
      f.x -= f.v*dt*0.4;
      f.y += Math.sin(f.t)*0.15;
      if(f.x < -40){ f.x = view.w + R(0,200); f.y = R(view.h*0.25, view.h*0.85); }
      ctx.beginPath();
      ctx.ellipse(f.x,f.y, f.s*0.12, f.s*0.06, 0, 0, Math.PI*2);
      ctx.fill();
    }
  }
  function drawSeaweed(t){
    const h=view.h, w=view.w;
    for(let i=0;i<7;i++){
      const x=(i/6)*w + Math.sin(t*0.3+i)*12;
      const base=h-6;
      ctx.strokeStyle='rgba(6,102,81,0.9)';
      ctx.lineWidth=8;
      ctx.beginPath(); ctx.moveTo(x, base);
      const k=4, seg=h*0.12;
      for(let j=1;j<=k;j++){
        const yy=base-j*seg;
        const xx=x + Math.sin(t*0.8 + i*0.7 + j*0.9)*16;
        ctx.lineTo(xx, yy);
      }
      ctx.stroke();
    }
  }

  /* ========================== Particles ========================== */
  function addPoof(x,y,n,color='rgba(255,255,255,0.9)'){
    for(let i=0;i<n;i++){
      poofs.push({x,y,vx:R(-120,120),vy:R(-160,0),g:520,life:R(0.4,0.8),r:R(2,4),c:color});
    }
  }

  /* ====================== Cartoon helpers & draw ====================== */
  function strokeFill(fill, stroke='#06263b', lw=4){ ctx.fillStyle=fill; ctx.strokeStyle=stroke; ctx.lineWidth=lw; }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  function drawBackground(t){
    const w=view.w, h=view.h;
    // light rays
    for(let i=0;i<6;i++){
      const x=((t*8+i*260)%(w+260))-260;
      const g=ctx.createLinearGradient(x,0,x+260,h);
      g.addColorStop(0,'rgba(255,255,255,0.03)'); g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=g; ctx.fillRect(x,0,260,h);
    }
    // caustics bands
    for(let i=0;i<3;i++){ const yy=h*0.55+Math.sin(t*0.6+i
